---
title: "TRABAJO 3"
author:
  - María Paula Camargo Rincón
  - Laura Katherin Martinez Castiblanco
  - Yudy Vanessa Puerres Rosero
date: "2025-12-13"
#output: pdf_document
editor_options: 
  markdown: 
    wrap: sentence
---

```{r, include=FALSE}
rm(list=ls())
```

# librerías

```{r message=FALSE, warning=FALSE, show=F}
#install.packages("readxl")
#install.packages("knitr")
#install.packages("forecast")
#install.packages("FinTS")
#install.packages("dplyr")
#install.packages("ggplot2")
#install.packages("lubridate")
#install.packages("zoo")
#install.packages("nortest")
library(readxl) # Para leer el csv
library(knitr) # Para obtener la tabla en el pdf a partir de una tabla en r
library(forecast) # para el lambda de box-cox
library(tseries) # prueba de estacionariedad adf
library(FinTS)
library(dplyr) # para manejo de datos
library(ggplot2) # para gráficas
library(lubridate) # fechas
library(zoo) #imputación de datos faltantes
library(nortest) # para prueba kolmogorov
library(dlm) # para modelo estructural
library(lmtest) #prueba breusch-pagan
```

# Descripción de los datos:

## Base de datos

La base de datos utilizada proviene del conjunto de datos público disponible en la plataforma Kaggle ([Rohan Rao, 2020](https://www.kaggle.com/datasets/rohanrao/air-quality-data-in-india)).
Este conjunto fue recopilado originalmente por el Central Pollution Control Board (CPCB), organismo oficial del Gobierno de la India encargado del monitoreo ambiental.

Para este estudio, se utilizó la versión diaria del conjunto de datos, enfocándose exclusivamente en la variable PM2.5 (µg/m³) (partículas en suspensión con diámetro aerodinámico $\leq$ 2.5 µm) registrada en la ciudad de Delhi.
La serie abarca el período comprendido entre el 1 de enero de 2015 y el 6 de diciembre de 2020, con observaciones diarias.

```{r paged.print=TRUE}
aire <- read_excel("Datos_India.xlsx")
aire <- aire %>% arrange(Date)
knitr::kable(head(aire,10),
             caption = "Primeros 10 datos",
             digits = 4)  # redondea a 4 decimales
```

Además de PM2.5, el conjunto incluye el Índice de Calidad del Aire (AQI) y su clasificación categórica (*AQI_Bucket*), que divide la calidad del aire en seis niveles: *Good*, *Satisfactory*, *Moderate*, *Poor*, *Very Poor* y *Severe*.
Sin embargo, dado que el objetivo del análisis es modelar la dinámica temporal de la concentración de PM2.5, se trabajó únicamente con la variable numérica continua.

```{r warning=FALSE, paged.print=TRUE}
# Convertir 'City' y 'AQI_Bucket' a variables de tipo factor
aire$City <- as.factor(aire$City)
aire$AQI_Bucket <- as.factor(aire$AQI_Bucket)

# Convertir 'Date' a una variable de fecha, especificando el formato
aire$Date <- as.Date(aire$Date, format = "%d/%m/%Y")

summary(aire)

str(aire)
```

## Evaluación de base de datos

```{r}
# Agrupar por fecha y contar el número de registros
daily_counts <- aire %>%
  group_by(Date) %>%
  summarise(count = n())

# Filtrar las fechas que tienen más de un registro
dates_with_duplicates <- daily_counts %>%
  filter(count > 1)

# Mostrar las fechas con registros duplicados
if (nrow(dates_with_duplicates) > 0) {
  cat("Días con más de un valor de PM2.5:\n")
  print(dates_with_duplicates)
} else {
  cat("No hay días con más de un valor de PM2.5\n")
}
# eliminar daily_counts para liberar memoria
rm(daily_counts)
```

El conjunto inicial contiene 2,009 observaciones.
Se identificaron 2 valores faltantes en la variable `PM2.5` y 10 en `AQI_Bucket`.
Dado que el AQI no se utilizará en el modelado, se centró la atención en imputar los valores ausentes de PM2.5.
Se aplicó interpolación lineal mediante la función `na.approx()` del paquete `zoo`, asumiendo que la evolución de la contaminación en el corto plazo no es drástica.

```{r paged.print=TRUE}
aire[!complete.cases(aire), ]
# Usar interpolación lineal para rellenar valores faltantes en 'PM2.5'
# Podemos usar la función na.approx del paquete zoo para la interpolación lineal.
aire$`PM2.5` <- na.approx(aire$`PM2.5`)

# Verificar que no haya más valores faltantes en 'PM2.5'
missing_pm25_after_imputation <- sum(is.na(aire$`PM2.5`))
cat("Número de datos faltantes en 'PM2.5' después de la imputacion:", missing_pm25_after_imputation, "\n")
```

Las estadísticas resumen de la serie de PM2.5 revelan una distribución altamente asimétrica hacia la derecha, con una media de 117.104 µg/m³, una mediana de 94.49 µg/m³ y un máximo extremo de 685.36 µg/m³.

```{r paged.print=TRUE}
summary_stats <- aire %>%
  summarise(
    Media = mean(`PM2.5`, na.rm = TRUE),
    Mediana = median(`PM2.5`, na.rm = TRUE),
    Desv_Est = sd(`PM2.5`, na.rm = TRUE),
    Min = min(`PM2.5`, na.rm = TRUE),
    Max = max(`PM2.5`, na.rm = TRUE)
  )

knitr::kable(summary_stats, digits = 3, caption = "Estadísticas descriptivas de PM2.5")


```

# Identificación de modelos

La gráfica de la serie de tiempo muestra una variabilidad, con estacionalidad clara (patrones repetidos, que parecieran ser anuales).
Aunque no se observa una tendencia, la varianza no es constante puesto que los picos son más pronunciados en ciertos períodos del año, lo que sugiere heterocedasticidad.

```{r fig.height=4, fig.width=10}
# Creación de la serie temporal
start_date <- min(aire$Date)
end_date <- max(aire$Date)
PM2.5 <- ts(aire$`PM2.5`, 
            start = c(year(start_date), month(start_date), day(start_date)), 
            end = c(year(end_date), month(end_date), day(end_date)), 
            frequency = 365)
PM2.5_zoom <- window(PM2.5, start = c(2016, 1), end = c(2018, 1))

# Configurar dos gráficos en una fila
par(mfrow = c(1, 2))

# Gráfico completo
ts.plot(PM2.5, col = "darkcyan", lwd = 1.5,
        ylab = "PM2.5 promedio diario", xlab = "Tiempo",
        main = "Serie completa")
# Gráfico con zoom
ts.plot(PM2.5_zoom, col = "darkcyan", lwd = 1.5,
        ylab = "PM2.5 promedio diario", xlab = "Tiempo",
        main = "Zoom: 2016-2017")

```

```{r fig.height=6.5, fig.width=10}
# Configurar panel 1x2: izquierda = serie completa, derecha = zoom
par(mfrow = c(2, 2))

## Panel izquierdo: Serie completa
acf(PM2.5, lag.max = 800, main = "ACF - 2 años", col = "darkcyan", lwd = 1) # 800 > 2*365 → muestra más de 2 años
pacf(PM2.5, lag.max = 800, main = "PACF - 2 años", col = "darkcyan", lwd = 1)
## Panel derecho: Serie con zoom (subconjunto)
acf(PM2.5, lag.max = 200, main = "ACF - Zoom (1er año)", col = "darkcyan", lwd = 1)   # ajusta lag.max al tamaño del subconjunto
pacf(PM2.5, lag.max = 50, main = "PACF - Zoom (1/4 de año)", col = "darkcyan", lwd = 1.25)
```

Podemos ver picos altos en los lag $0$, $1$ y $2$ en el ACF, los cuales son decrecientes y hacen referencia a la estacionalidad anual, es decir el lag 1 hace referencia al día 365 (1 año), el lag 2 al día 730 (2 años).

Para evaluar formalmente la estacionariedad en media (la cual segun gráficos parece ser estacionaria), se usa la prueba de Dickey-Fuller (ADF).
El estadístico resultante fue -8.233 con un p-valor \< 0.01, lo que permite rechazar la hipótesis nula de raíz unitaria.
Por lo tanto, la serie se considera estacionaria.

```{r}
adf.test(PM2.5, alternative = "stationary")
```

Al aplicar la descomposición STL (Seasonal-Trend-Loess) se confirma visualmente lo encontrado anteriormente; El componente estacional exhibe un patrón anual repetitivo, con picos consistentes a finales de año.
Al evaluar la tendencia de la serie, se evidencia como aumentan la cantidad de PM2.5, la cual se reduce considerablemente en lo que parese el periodo de pandemia.

```{r fig.height=6.5, fig.width=10}
# Descomposición STL
plot(stl(PM2.5, s.window = "periodic"), col = "darkcyan", lwd = 1.25)
```

Dada la heterocedasticidad, se evaluo una transformación para estabilizar la varianza.
Se estimó el parámetro de Box-Cox, obteniéndo $\lambda$ $\approx$ 0.105, cercano a cero.
Por lo cual se aplicó la transformación logarítmica.

```{r fig.height=4, fig.width=10}
lambda <- BoxCox.lambda(PM2.5)
lambda

# Transformación logarítmica
l.PM2.5 <- log(PM2.5)
ts.plot(l.PM2.5, col = "darkcyan", lwd = 1.25,
        ylab = "log(PM2.5 promedio diario)",
        main = "Serie transformada logarítmicamente")
```

La serie transformada presenta una varianza más homogénea y mantiene la estacionariedad en media (prueba ADF con p-valor \< 0.01), sin embargo, a su vez mantiene la estacionalidad anual.

```{r}
adf.test(l.PM2.5,alternative = "stationary")
```

Luego de aplicar la transformación logarítmica a la serie de PM2.5, el test de Dickey–Fuller Aumentado (ADF) arrojó un estadístico de -7.701 con un p-valor \< 0.01, lo que indicaría estacionariedad a un nivel de significancia del 5%.
Sin embargo, la inspección de la función de autocorrelación (ACF) revela un decaimiento lento, señal de persistencia temporal y posible estacionalidad anual.
A su vez se observa en la descomposición STL que la estructura estacional anual persiste con patrones cíclicos bien definidos cada año.
Ademas al evaluar los residuales reflejan un comportamiento aleatorio, luego la transformación permite capturar adecuadamente la serie.

```{r fig.height=6.5, fig.width=10}
# Descomposición STL 
plot(stl(l.PM2.5, s.window = "periodic"), col = "darkcyan", lwd = 1.25)
```

# Modelo Estructural en Estado Espacio

A partir de la serie diaria de PM2.5, se plantea un modelo estructural en forma de espacio–estado compuesto por un nivel y un componente estacional anual.

## Ecuación de Observación

$$
y_t = \mu_t + s_t + \varepsilon_t, 
\qquad \varepsilon_t \sim N(0, V)
$$

donde $y_t$ representa la serie observada ($y_t=\log(\text{PM2.5}_t)$), $\mu_t$ es el nivel (tendencia de largo plazo), $s_t$ es la componente estacional anual y $\varepsilon_t$ es el error de observación.

## Ecuación de Estado (nivel)

Se considera un nivel local: 
$$
\mu_t = \mu_{t-1} + \eta_t, 
\qquad \eta_t \sim N(0, W_\mu)
$$

En caso de asumir nivel determinístico, se fija $W_\mu=0$.

## Ecuación de Estado (Estacionalidad Trigonométrica)

La estacionalidad anual se modela mediante una representación trigonométrica (Fourier): 
$$
s_t = \sum_{k=1}^{q}\left[
a_k \cos\left(\frac{2\pi k t}{365}\right) +
b_k \sin\left(\frac{2\pi k t}{365}\right)
\right]
$$ 
donde $q=16$ es el número de armónicos utilizados para aproximar el ciclo anual.



## Estimación del Modelo Mediante Filtrado y Suavizado de Kalman

A continuación, se estima el modelo estructural en espacio–estado mediante el filtro y el suavizado de Kalman, utilizando el paquete dlm. El filtrado permite obtener estimaciones en tiempo real del estado, mientras que el suavizado utiliza toda la información disponible para estimar de manera más precisa los componentes latentes del modelo.

```{r fig.height=5, fig.width=10}

y3 <- l.PM2.5

# Modelo optimizado: Nivel local + Estacional trigonométrica (8 armónicos para anual)
mod_trig <- dlmModPoly(order=1, dV=2, dW=0) +  # Nivel constante (W=0 para determinístico)
            dlmModTrig(s=365, q=16, dV=0, dW=0)  # s=periodo, q=armónicos, varianzas fijas

# Filtrado y suavizado
system.time({  # Mide tiempo
  y3_filtro <- dlmFilter(y3, mod_trig)
  y3_suave <- dlmSmooth(y3, mod_trig)
})

# Extracción: Nivel en [,1], estacional en columnas siguientes (pares sin/cos)
nivel_filtro <- dropFirst(y3_filtro$m)[,1]
estacional_filtro <- rowSums(dropFirst(y3_filtro$m)[,2:ncol(y3_filtro$m)])  # Suma armónicos
# Extracción: Nivel en [,1], estacional en columnas siguientes (pares sin/cos)
nivel_suave <- dropFirst(y3_suave$s)[,1]
estacional_suave <- rowSums(dropFirst(y3_suave$s)[,2:ncol(y3_suave$s)])  # Suma armónicos


# Plots comparativos (similar a tu código)
par(mfrow=c(1,2))
ts.plot(y3, col="darkgrey", main="Serie vs Nivel + Estacional (filtro)")
lines(nivel_filtro + estacional_filtro, col="darkcyan", lty=2)
ts.plot(y3, col="darkgrey", main="Serie vs Nivel + Estacional (suavizado)")
lines(nivel_suave + estacional_suave, col="darkcyan", lty=2)
```
La Figura muestra la serie observada de PM2.5 en escala logarítmica (línea gris) junto con el ajuste obtenido a partir del modelo estructural en espacio–estado (línea azul discontinua), correspondiente a la suma del nivel estimado y la componente estacional anual, para el método de suaviazdo y para el método de filtrafo. Se observa que el modelo suavizado logra capturar adecuadamente la dinámica general de la serie, reproduciendo de forma clara el patrón estacional anual caracterizado por picos recurrentes y valles pronunciados. Asimismo, el nivel estimado presenta una evolución suave en el tiempo, lo que sugiere cambios graduales en la concentración promedio de PM2.5. En conjunto, el ajuste indica que el modelo estructural proporciona una representación adecuada de la serie.

Por otro lado el modelo filtrado durante el primer año se observa un comportamiento más inestable, asociado al proceso de inicialización del filtro de Kalman. A partir de este período transitorio, el ajuste filtrado converge y presenta un comportamiento similar al del suavizado.


## Validación del modelo: análisis de residuos del suavizado

Los residuales del modelo suavizado se definieron como la diferencia entre la serie observada y el valor ajustado suavizado del modelo.

```{r fig.height=7, fig.width=10}
ajuste <- nivel_suave + estacional_suave
# --- 1. Obtener residuos de 1 paso adelante (una-pass) ---
residuos <- y3-ajuste
# --- 2. Gráficos de diagnóstico ---
par(mfrow = c(3, 2))

# a) Serie original vs ajustado
ts.plot(y3, col = "darkgrey", main = "Serie vs Ajuste (suavizado)")
lines(ajuste, col = "darkcyan")

# b) Residuos en el tiempo
plot(residuos, main = "Residuos del modelo", ylab = "Residuo")

# c) ACF de residuos
Acf(residuos, main = "ACF de residuos")

# d) Histograma + QQ
hist(residuos, breaks = 70, main = "Distribución de residuos", xlab = "Residuo" , col = "darkcyan")
qqnorm(residuos); qqline(residuos, col = "darkcyan")
```
En la primera imagen vemos el ajuste del modelo en azul junto con la serie logarítmica en gris, se puede ver que el modelo reproduce adecuadamente el nivel y la estacionalidad principal de la serie, capturando la dinámica de largo plazo y el patrón anual dominante. El ajuste suavizado sigue de cerca la trayectoria promedio de los datos, aunque no pretende capturar la variabilidad de alta frecuencia.

Por otro lado Tenemos en la segunda imágen los residuos del modelo, los cuales parecen oscilar en un inicio alrededor de cero, sin embargo parecen tener un leve desplazamiento al final del periodo, a pesar de esto, parecen presentar una variabilidad constante, lo que nos puede indicar que no hay problemas de heteroscedásticidad, de lo cual se profundizará más adelante. Tambien pudimos observar en el histograma y en el qq-plot una distribución aproximadamente normal de los residuales.

Finalmente la función de autocorrelación de los residuales muestra correlaciones positivas significativas en varios rezagos, lo que indica que persiste dependencia temporal no explicada completamente por el modelo. Esto sugiere la presencia de estructura adicional, posiblemente estacional o de corto plazo, que no fue capturada por el componente suavizado.

```{r fig.height=7, fig.width=10}
# --- 1. Obtener residuos de 1 paso adelante (una-pass) ---
residuos <- residuals(y3_filtro, type = "raw")

# --- 2. Gráficos de diagnóstico ---
par(mfrow = c(3, 2))

# a) Serie original vs ajustado
ajuste <- nivel_filtro + estacional_filtro
plot(y3, col = "darkgrey", main = "Serie vs Ajuste filtrado")
lines(ajuste, col = "darkcyan")


# b) Residuos en el tiempo
plot(residuos$res, main = "Residuos del modelo", ylab = "Residuo")

# c) ACF de residuos
Acf(residuos$res, main = "ACF de residuos")

# d) Histograma + QQ
hist(residuos$res, breaks = 70, main = "Distribución de residuos", xlab = "Residuo", , col = "darkcyan")
qqnorm(residuos$res); qqline(residuos$res, col = "darkcyan")
```

Como se mencionó anteriormente el modelo captura adecuadamente la dinámica despues del primer año. 

Analizando los residuales del modelo filtrado se observa que estos oscilan alrededor de cero a lo largo del período de estudio. Durante el primer año se aprecia una mayor variabilidad, lo cual puede atribuirse al efecto de inicialización del filtro de Kalman; posteriormente, la varianza se estabiliza y permanece aproximadamente constante en los períodos siguientes, lo que sugiere homoscedasticidad.

Asimismo, el histograma de los residuales muestra una distribución aproximadamente simétrica alrededor de cero y el gráfico Q–Q indica un comportamiento cercano a la normalidad, con desviaciones menores en los extremos.

Si bien se observan correlaciones significativas en algunos rezagos aislados, no se aprecia una estructura de autocorrelación persistente, lo que sugiere que el modelo captura adecuadamente la dependencia temporal principal.

## Conlusiones

* Ambos modelos representan bien la tendencia y la estacionalidad, pero el suavizado ofrece un ajuste más estable desde el inicio.

* El modelo suavizado representa la dinámica de largo plazo y la estacionalidad principal, pero podría faltar capturar estructura adicional de corto plazo o efectos residuales.

* El modelo filtrado es adecuado para representar la serie después del periodo de inicialización, con buena captura de tendencia, estacionalidad y dependencia temporal.

* Para análisis descriptivo y visualización de patrones generales, el suavizado es preferible; para pronósticos paso a paso y análisis de series temporales, el filtrado es más adecuado.
